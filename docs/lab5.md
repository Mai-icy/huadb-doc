# 实验 5:查询优化

## 实验概述
本次实验为数据库系统查询优化的实验，意图通过查询重写和连接顺序选择来让学生们更好地理解数据库系统如何选择查询代价较低的执行计划。

查询优化是数据库系统提供高性能查询的关键组件。这一模块的相关研究自数据库系统起源以来一直广受学界和业界的关注。具体实现上，查询优化相关的算法种类丰富，覆盖范围囊括了查询重写、物化视图、连接顺序选择、索引选择、算子选择、代价估计等诸多方面。实验框架选择了其中比较经典且重要的部分作为本地的实验内容：查询重写和连接顺序选择。

查询重写按照查询等价转化规则修改查询计划树结构，本次实验涉及其中实现相对简单的算子下推规则，通过完成算子的下推可以优化扫描算子的执行和基数估计。连接顺序选择的难点有二：第一是连接算子执行代价的估计，不同表不同列之间一般不满足独立分布假设，显著提高连接代价估计的难度。第二是连接顺序选择算法的复杂度，在连接数量较多时，讨论所有的连接顺序组合将面临指数级的复杂度，对于系统负担过高。本次实验的基础功能要求实现选择和连接算子的下推功能，并降低了连接顺序选择的实现难度，仅要求在满足课程简化假设条件下实现的连接顺序选择。高级功能要求在此基础上添加投影算子下推功能，并使用基于数据画像优化基数估计过程，从而优化连接顺序选择功能。

![](./pics/lab5-overview.svg) 

## 实验目标
本次实验要求学生完成如下基础功能：

1. 选择和连接算子下推：补全优化器结构体中中选择和连接算子下推的相关函数，实现选择算子下推。

2. 连接顺序选择：在满足课程简化假设条件下，基于基数估计的实现使用贪心算法的连接顺序选择。

在基础功能之上，实验框架支持学生完成以下高级功能：

1. 投影算子下推：补全优化器结构体中投影算子下推的相关函数，实现投影算子下推。需要维护查询数的下推后变化的数据列信息。

2. 连接选择优化：实现基于动态规划算法的连接顺序选择，优化连接顺序选择的查找空间。

2. 基于数据画像的基数估计：使用数据画像方法实现更准确的基数估计，优化连接顺序选择的准确性。

## 关联知识点

本次实验关联课件查询优化章节，重点涉及如下的知识点：

1. 查询重写：本次实验需要理解查询重写中算子下推的重写规则和具体实现方式。
2. 连接顺序选择：本次实验需要理解简化假设下连接运算的基数估计，高级功能要求理解基于数据画像的基数估计方法。

## 相关代码模块
本次实验涉及到代码中如下的功能模块：

- [optimizer](https://git.tsinghua.edu.cn/dbtrain/dbtrain-lab/-/blob/master/src/optimizer)：优化器相关结构体
    - [optimizer](https://git.tsinghua.edu.cn/dbtrain/dbtrain-lab/-/blob/master/src/optimizer/optimizer.h)：优化器结构体，需要补全算子下推功能以及连接算子重新排序的功能。

<!--TODO:添加Analyze相关函数-->

相关功能模块的抽象示意图如下：

![](./pics/lab5-details.svg)

## 基础功能

基础功能侧重于函数功能的补全，通过阅读相关函数的输入输出描述以及函数解释即可完成。

### 选择算子下推

#### 实验描述

补全优化器Optimizer结构体中关于选择和连接算子下推的相关函数，实现算子下推功能。

#### 实现思路

- 步骤0：思考并补全Optimizer实现算子下推功能缺少的成员变量。

- 步骤1：补全PushDownFilter函数，根据Filter条件判断算子为选择算子还是连接条件算子，分别添加到步骤0中添加的成员变量中。

- 步骤2：补全PushDownSeqScan函数，根据步骤1记录的选择算子调整扫描算子的结构，添加对应的过滤条件。

- 步骤3：补全PushDwonJoin函数，根据步骤1记录的连接条件算子调整连接算子的实现方式，将原始的笛卡尔积算子优化为根据条件连接算子。

### 简化假设下连接顺序选择

#### 实验描述

补全优化器Optimizer结构体中ReorderJoin函数以及数据库Analyze功能，实现数据表信息统计、基数估计以及连接顺序选择。

#### 实现思路

- 步骤1：补全直方图结构体的生成以及查询函数，用于后续的基数估计。

- 步骤2：补全数据库Analyze功能，实现数据表的信息统计功能，需要调用直方图的生成函数并正确存储到系统表statistic表中。

- 步骤3：补全Optimizer::RejoinOrder函数，补全连接顺序选择算法，使用贪心算法实现这一过程。


## 高级功能

### 投影算子下推

#### 实验描述

基础功能中完成了选择和连接算子的下推，高级功能中要求在此基础上添加投影算子的下推功能。

#### 实现思路

- 步骤0：理解投影算子下推相较于选择算子的区别，思考如何在算子下推后维护数据列信息。

- 步骤1：修改Optimizer结构体，添加用于辅助PushProjection函数的相关私有成员函数和成员变量。

- 步骤2：补全Optimizer结构体的PushProjection函数，注意并非部分连接运算后需要添加投影运算。

### 连接选择优化

#### 实验描述

基础功能中的连接顺序选择使用的是贪心算法，高级功能中要求在此基础上添加基于动态规划的连接顺序选择算法。

#### 实现思路

在ReorderJoin函数中基于连接种类选择使用的算法类型，并在Optimizer中添加基于动态规划的连接顺序选择算法的成员函数。

### 基于数据画像的基数估计

#### 实验描述

基础功能中连接顺序选择过程基于了独立性简化假设进行技术估计，高级功能中要求使用数据画像来提高基数估计步骤的准确性（基于Count-Min或HyperLogLog算法）。

#### 实现思路

- 步骤0：理解Count-Min，HyperLogLog算法的原理和实现。

- 步骤1：修改数据库Analyze过程，在分析过程中添加Count-Min或HyperLogLog算法所需的统计数据（可在statistic系统表添加新的列）。

- 步骤2：修改Optimizer结构体中估计连接顺序基数的相关函数，使用Count-Min或HyperLogLog算法进行更加准确的基数估计。

<!--TODO:添加部分教材中的示意图-->

## 测试说明
本次实验需要通过如下X类测试：

## 实验报告

实验报告应该具备如下3部分内容：

1. 基础功能的新增成员变量和函数

以模块（文件夹）为划分标准，分栏目介绍在实验中新增的成员变量与成员函数，并简要概括其作用。

2. 基础功能的难点总结

总结在完成基础功能中遇到的实现或理解方面的难点，分要点记录于这部分，建议不超过5点。

3. **高级功能的设计与实现**

这部分可以作为报告的重点内容，要求详细阐述高级功能的设计思路与实现方法。
可以按照如下流程进行介绍：

(1) 相关原理与示意图：总结高级功能对应的知识点，并绘制示意图。

(2) 新增结构体的描述：介绍在基础框架之上添加的新的结构体的功能，以及和已有一些结构体的关联关系。

(3) 新增成员函数的描述：介绍新增或已有结构体上增加的重要成员函数，以及这些函数的功能描述和调用关系。

(4) 高级功能效果展示：结合新增或已有的测试用例，说明新增的高级功能的正确性或优化效果。 


## 问题反馈

### 框架BUG反馈
有关于实验框架的问题可以在公开仓库中提交[git issues](https://git.tsinghua.edu.cn/dbtrain/dbtrain-lab/-/issues/new)。
或者直接提交包含问题描述和修复补丁的[pull request](https://git.tsinghua.edu.cn/dbtrain/dbtrain-lab/-/merge_requests/new)。

