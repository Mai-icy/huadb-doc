# 基础功能

## 任务 1：解决万圣节问题

还记得在实验 1 中提到的万圣节问题吗，本次实验的第一个任务便是解决这个问题，完成后你将通过 `05-halloween.test` 测例。

### 步骤 1：添加记录头信息

记录头信息位于 `record_header.h` 文件，具体包括以下几个字段：

| 变量名    | 变量类型 | 长度 | 作用                                |
| --------- | -------- | ---- | ----------------------------------- |
| deleted\_ | bool     | 1    | 标注记录是否删除（实验 3 之后弃用） |
| xmin\_    | xid      | 4    | 插入该数据的事务 id                 |
| xmax\_    | xid      | 4    | 删除该数据的事务 id                 |
| cid\_     | cid_t    | 4    | 插入该数据的事务内部 command id     |

实验框架的 TransactionManager 类会在每个事务开启时为其分配一个事务 id，记为 xid。在每个事务内部，TransactionManager 会为每条 SQL 语句分配一个 command id，记为 cid，我们将通过 cid 来解决万圣节问题。

你需要在修改实验 1 插入、删除记录和实验 2 中撤销删除记录的代码，涉及 TablePage 的 InsertRecord, DeleteRecord 和 UndoDeleteRecord 函数，在插入、删除以及撤销删除记录时正确设置记录头信息，在插入记录时设置 xmin 和 cid，删除和撤销删除记录时设置 xmax。

### 步骤 2：修改可见性判断条件

下一步你需要修改 table_scan.cpp 中 GetNextRecord 函数关于可见性判断的部分，为了解决万圣节问题，我们不仅需要判断记录是否被删除，还要判断读入的记录是不是由当前正在执行的 SQL 语句插入的，判断依据便是记录的 xid 和 cid，当前正在执行的 SQL 语句的 xid,和 cid。正确修改判断条件后，你将通过`10-halloween.test` 测例。同时，你也要保证代码的修改不影响前两次实验的正确性。

## 任务 2：通过多版本并发控制实现可重复读隔离

本任务中，你将使用多版本并发控制，来实现可重复读隔离级别，正确实现后将通过 `20-mvcc_insert.test`, `21-mvcc_delete.test`, `22-mvcc_update.test` 和 `23-write_skew.test` 测例。

### 实验描述

多版本并发控制用于解决并发查询处理中的读写和写读冲突，需要在 Table 相关类中添加版本信息以及并在查询记录时判断记录对事务的可见性。

### 实现思路

-   步骤 1：修改 Table 类插入、删除以及更新记录的函数，添加版本信息。

在实验 1 和 2 中完成的 Table 和 TablePage 的处理中没有考虑到事务的版本信息，需要在本次实验中将其补充。

-   步骤 2：补全 SeqScanExecutor::Next 函数中活跃事务表的获取，用于传递当前活跃事务信息。

多版本并发控制的数据表扫描中需要获取查询执行时的活跃事务表，结合隔离级别生成正确的活跃事务表即可。

-   步骤 3：补全 TableScan 的 IsVisible 函数，用于在查询记录时判断记录版本对于事务的可见性。

根据隔离级别、记录的版本号以及当前事务的状态信息确定某条记录是否对于该事务可见。这部分是 MVCC 技术的关键的内容，建议充分理解课程内容后实现。

完成上面三个步骤即可补全多版本并发控制的功能。

## 任务 2：两阶段锁协议

### 实验描述

悲观并发控制用于解决并发查询处理中写写冲突，需要实现两阶段锁协议来避免不同事务对于相同记录的冲突修改，实验中需要补全锁管理器相关类。

### 实现思路

-   步骤 1：补全 LockManager 的相关函数，完成表级锁和行级锁的控制和管理。

<!--TODO:此处可以添加锁的级别-->

LockManager 定义了表级锁和行级锁的相关接口，同时按照不同等级区分了多种类型的锁结构。实验要求补全表级别和行级别的加锁和解锁函数，以及相关的辅助函数。
需要特别注意，实验框架中仅实现了事务锁，没有实现页面锁。

-   步骤 2：补全算子中申请锁的部分。

补全 Insert、Delete 和 Unpdate 三个算子执行过程中的写锁申请部分，用于解决基本的写写冲突。
补全 LockRows 算子执行过程中的读锁或写锁的申请，用于支持 SELECT ... FOR SHARE 和 SELECT ... FOR UPDATE 类查询语句。

完成上面两个步骤即可补全基于两阶段锁的悲观并发控制的功能。

## 基础功能实现顺序及测例分析

### 修改插入删除操作，在记录头存储 xid cid，通过 lab 1 和 lab 2 所有测例

### 解决 Halloween Problem

### 增加读已提交隔离级别下的可见性判断

### 实现可重复读，通过 MVCC 测例

### 完成锁管理器，增加加锁逻辑

### 实现读未提交

### 实现 MV2PL 逻辑，判断锁的相容性
