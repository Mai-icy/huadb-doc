# 实验 4:查询处理

## 实验概述
本次实验为数据库系统查询处理的实验，意图通过实现基于火山模型的执行器引擎来让学生们更好地理解数据库系统如何按照查询算子逐级处理查询请求。

执行器是数据库系统将磁盘存储的页面数据处理为符合查询所需结果的模块。火山模型是一种经典的拉取式执行器模型，通过抽象算子的执行逻辑，上层算子逐层从下层算子拉取数据，算子内部完成处理后响应上层的拉取请求。通过这种方式可以在抽象结构上构建一种结构上非常简介的执行器模型，便于在执行引擎实现上的查询优化和异常处理。

<!--TODO:火山模型结构图-->

算子的实现是本次实验的难点。火山模型基于策略模式可以设计出不同的算子结构，并结合工厂模式可以快速创建不同类型的算子。系统根据物理计划树逐层生成算子，并调用算子的拉取函数完成查询的实际执行。部分算子在内部处理过程中需要存储中间结果来加速算子执行，例如连接算子以及聚合算子等，这种情况一般会使用内存作为中间结果的缓存。但是，部分算子在执行过程中将产生巨大存储容量的中间结果，不能够简单地存储到内存中（例如大表间的连接运算）。这类算子需要引入磁盘作为外部存储，一般称为外存算子，其中包括外存连接和外存排序算子。外存算子的执行效率对于磁盘IO的开销敏感，在实现上相较于内存算子更为复杂。本次实验要求补全几个常见的算子：连接、排序、Limit、聚合。考虑到不同算子本身实现难度的差异，基础功能中要求完成内存中的NestLoopJoin、MergeJoin两类连接算子、排序算子以及Limit算子，高级功能在此基础上要求中引入内存资源的限制，并设计相应运算的外存算子，同时也可以选择实现难度较高的哈希连接算子以及聚合算子（二者均需要补全哈希表结构体的相关函数）。

![](./pics/lab4-overview.svg) 

## 实验目标
本次实验要求学生完成如下基础功能：

1. Limit算子：补全Limit算子，一个功能非常简单的算子，不需要保存复杂的中间结果。

2. 内存排序算法：补全排序算子，中间结果使用成员变量保存在内存中。

3. 内存连接算子：补全NestLoop和Merge两类连接算子，中间结果使用成员变量保存在内存中。

在基础功能之上，实验框架支持学生完成以下高级功能：

1. 外存排序和连接算子：在内存排序和连接算子的基础上添加内存限制，使用外存储存中间结果，并设计内外存数据交互机制加速外存算法处理。

3. 内存哈希连接算子+聚合算子：实现内存存储的哈希表结构体，并基于哈希表实现内存哈希连接算子以及聚合算子，中间结果利用哈希表保存。


## 关联知识点

本次实验关联课件查询处理与执行器章节，重点涉及如下的知识点：

1. 火山模型：本次实验需要充分理解火山模型的设计思路以及查询的实际执行流程。
2. 内存算子：本次实验的基础功能要求理解基于内存的连接、排序、聚合等算子的算法实现以及计算、存储代价分析。
3. 外存算子：本次实验的高级功能要求理解基于外存的连接、排序算子的算法实现以及计算、存储代价和IO代价分析。


## 实验任务（基础）

### 1. 实现 Sort Merge Join

### 2. 添加聚合算子 (支持 Group By)

## 实验任务（进阶）

### 1. 外存算子

### 2. 算子并行化
